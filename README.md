# ZCron - 分布式定时任务调度系统

ZCron 是一个基于 Go 语言实现的分布式定时任务调度系统，提供简单易用的 Web 界面用于任务管理。该系统采用 Master-Worker 架构，通过事件驱动机制实现组件间通信，确保系统的稳定性和可扩展性。

## 技术栈

- **后端**：Go + Gin
- **前端**：Vue.js
- **存储**：etcd (任务元数据)、MongoDB (执行日志)
- **调度框架**：[robfig/cron](https://github.com/robfig/cron)

## 系统架构

ZCron 系统由以下三个主要组件构成：

1. **Master 节点**：任务管理服务器
2. **Worker 节点**：任务执行器
3. **Web 界面**：任务管理界面

### 核心依赖

- **etcd**：作为服务发现和分布式协调的存储中心
- **MongoDB**：用于存储任务执行日志
- **Vue.js**：前端 Web 界面

## 组件介绍

### Master 组件

Master 节点是 ZCron 系统的控制中心，主要负责：

- 提供 HTTP API 接口，接收和处理来自 Web 界面的任务管理请求
- 将任务信息持久化到 etcd 中
- 管理任务的元数据（添加、删除、修改任务）
- 负责任务状态的管理和监控

Master 组件不直接与 Worker 通信，而是通过在 etcd 中写入任务信息，由 Worker 监听 etcd 中的变化来获取任务。

### Worker 组件

Worker 节点是 ZCron 系统的执行引擎，主要负责：

- 监听 etcd 中的任务变化事件
- 基于 Cron 表达式调度和执行任务
- 通过分布式锁机制确保任务的单次执行
- 将任务执行日志写入 MongoDB
- 处理任务的终止（Kill）操作
- 实现节点自动注册，支持水平扩展

Worker 使用高效的事件驱动模型，监听任务保存、删除和终止等事件，并做出相应处理。

### Web 界面

基于 Vue.js 实现的前端管理界面，提供：

- 任务的创建、编辑和删除
- 任务列表展示和搜索
- 任务执行日志查看
- Worker 节点状态监控

## 事件驱动机制

ZCron 采用事件驱动的通信方式，避免了 Master 和 Worker 之间的直接通信：

1. **任务管理事件**：
   - Master 将任务保存到 etcd 的 `cron/jobs/` 目录
   - Worker 通过 etcd Watch 机制监听任务变化事件

2. **任务终止事件**：
   - Master 在 etcd 的 `cron/killer/` 目录写入终止命令
   - Worker 监听到终止事件后停止对应的任务

3. **分布式锁机制**：
   - 使用 etcd 的 `cron/lock/` 目录实现分布式锁
   - 确保同一任务在不同 Worker 节点间互斥执行

4. **Worker 注册**：
   - Worker 启动时自动注册到 etcd 的 `cron/workers/` 目录
   - 实现 Worker 节点的自动发现和负载均衡

## 高可用设计

系统的高可用性主要依赖于以下几点：

1. **无状态设计**：
   - Master 和 Worker 均采用无状态设计，可水平扩展
   - 任何组件故障不影响整体系统稳定性

2. **etcd 集群**：
   - 必须确保 etcd 的高可用部署（建议至少 3 节点集群）
   - etcd 作为系统的"神经中枢"，存储任务元数据和分布式锁信息

3. **MongoDB 集群**：
   - 推荐使用 MongoDB 复制集或分片集群确保日志存储的高可用
   - 任务执行日志的持久化存储

4. **Worker 自动发现**：
   - Worker 节点可以动态加入或离开集群
   - 系统自动感知 Worker 的存活状态

## 部署建议

1. Master 和 Worker 可以部署在同一台机器上，也可以分开部署
2. 建议 etcd 至少部署 3 节点集群，确保高可用
3. MongoDB 建议使用复制集部署，确保数据持久化的可靠性
4. Worker 节点可根据业务负载进行水平扩展

